<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PianoBuddy</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Inter:wght@400;600&display=swap"
    rel="stylesheet">

  <!-- Core Styles -->
  <link rel="stylesheet" href="./styles.css" />

  <!-- React Dependencies -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Confetti for Celebration -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    // DATA: Buddies
    const buddies = [
      {
        id: 'melody',
        name: 'Melody the Cat',
        assets: {
          happy: './assets/melody_happy_sora.PNG',
          anxious: './assets/melody_tired.PNG',
          sleepy: './assets/melody_sleepy.PNG',
          videoHappy: './assets/melody_happy_video.mp4',
          videoSleepy: './assets/melody_sleeping_video.mp4'
        },
        color: '#FF8F5E'
      },
      {
        id: 'rhythm',
        name: 'Rhythm the Panda',
        assets: {
          happy: './assets/rhythm_happy_sora.PNG',
          anxious: './assets/rhythm_anxious.PNG',
          sleepy: './assets/panda_sleepy.JPG',
          videoHappy: './assets/rhythm_happy_video.mp4',
          videoSleepy: './assets/rhythm_sleepy_video.mp4'
        },
        color: '#4BC2A5'
      },
      {
        id: 'sparkle',
        name: 'Sparkle the Unicorn',
        assets: {
          happy: './assets/sparkle_happy_sora.PNG',
          anxious: './assets/sparkle_anxious.PNG',
          sleepy: './assets/sparkle_sleepy.JPG',
          videoHappy: './assets/sparkle_happy_video.mp4',
          videoSleepy: './assets/sparkle_sleepy_video.mp4'
        },
        color: '#FFB7B2'
      },
      {
        id: 'splash',
        name: 'Splash the Dolphin',
        assets: {
          happy: './assets/splash_happy_sora.PNG',
          anxious: './assets/splash_anxious.PNG',
          sleepy: './assets/splash_sleepy.JPG',
          videoHappy: './assets/splash_happy_video.mp4',
          videoSleepy: './assets/splash_sleepy_video.mp4'
        },
        color: '#64C5EB'
      }
    ];

    // DATA: Quotes
    const quotes = {
      happy: [
        "Yay! You finished the tune—great focusing!",
        "Awesome job sticking with the music!",
        "You did it! Your practice power is growing!",
        "Nice playing—your fingers were working hard!",
        "Hooray! You stayed focused to the end!",
        "Great job trying your best on that tune!",
        "Wow! That was some careful practicing!",
        "You're getting better every time you practice!",
        "High five! You didn't give up!",
        "That was a strong practice—well done!",
        "Fantastic! You kept your eyes and ears on the music!",
        "Nice work finishing the whole song!",
        "You practiced like a music hero!",
        "I love how hard you tried just now!",
        "Great focus—your piano heard you!",
        "That tune got better because you practiced!",
        "You're training your fingers—good job!",
        "Yay! Another practice round complete!",
        "You stayed calm and kept going—awesome!",
        "That was some super practice power!",
        "Way to go! You paid attention the whole time!",
        "You're learning more with every try!",
        "Nice job working through the song!",
        "Practice win! You finished the tune!",
        "Your effort made that music shine!",
        "You're doing exactly what musicians do!",
        "Great job using your focus muscles!",
        "You're getting stronger at piano practice!",
        "That was careful playing—I liked it!",
        "You gave that tune a good try—yay!",
        "You practiced with your whole brain—nice!",
        "That was a smart and steady practice!",
        "You didn't rush, and that helped—good job!",
        "Another tune done—keep it up!",
        "You're building piano skills step by step!",
        "I can hear how hard you worked!",
        "That was fun practice—great job!",
        "You stayed with the song—awesome focus!",
        "You're becoming a piano pro, one tune at a time!",
        "Nice effort! Your practice really counts!",
        "You kept going even when it was tricky—wow!",
        "That was a brave try—great job!",
        "You're helping your fingers learn—yay!",
        "Practice complete! You did your best!",
        "You played with care—well done!",
        "That was a happy practice moment!",
        "You're doing great by practicing every time!",
        "Your focus helped that tune sound better!",
        "You finished the song—celebration time!",
        "Great practice! Ready for the next adventure?"
      ],
      anxious: [
        "Are you still there?",
        "I'm waiting for the next song...",
        "Let's practice soon!",
        "Don't give up now!",
        "The piano misses you!",
        "Time for one more try?",
        "I'm getting a bit lonely..."
      ],
      sleepy: [
        "Zzz... oh! You're back!",
        "I dreamt of music...",
        "Is it time to play again?",
        "*Yawn* Ready when you are!",
        "Wake me up with a tune!"
      ]
    };

    // CONTEXT: AppContext
    const { createContext, useState, useEffect, useContext, useRef } = React;
    const AppContext = createContext();

    const AppProvider = ({ children }) => {
      const [currentBuddyId, setCurrentBuddyId] = useState(null);
      const [view, setView] = useState('onboarding');
      const [goals, setGoals] = useState([]);
      const [inactivityThreshold, setInactivityThreshold] = useState(5);

      // GLOBAL TIMER STATE
      const [sessionActiveSeconds, setSessionActiveSeconds] = useState(0);
      const [hasStarted, setHasStarted] = useState(false);

      const addGoal = (tuneName, targetCount) => {
        const newGoal = {
          id: Date.now().toString(),
          tuneName,
          targetCount: parseInt(targetCount),
          currentCount: 0
        };
        setGoals(prev => [...prev, newGoal]);
      };

      const removeGoal = (id) => {
        setGoals(prev => prev.filter(g => g.id !== id));
      };

      const incrementProgress = (id) => {
        if (!hasStarted) setHasStarted(true); // Start global timer on first progress
        setGoals(prev => prev.map(g => {
          if (g.id === id) {
            return { ...g, currentCount: g.currentCount + 1 };
          }
          return g;
        }));
      };

      const resetDailyProgress = () => {
        setGoals(prev => prev.map(g => ({ ...g, currentCount: 0 })));
        setSessionActiveSeconds(0);
        setHasStarted(false);
      };

      const value = {
        currentBuddyId,
        setCurrentBuddyId,
        view,
        setView,
        goals,
        addGoal,
        removeGoal,
        incrementProgress,
        resetDailyProgress,
        inactivityThreshold,
        setInactivityThreshold,
        sessionActiveSeconds,
        setSessionActiveSeconds,
        hasStarted,
        setHasStarted
      };

      return (
        <AppContext.Provider value={value}>
          {children}
        </AppContext.Provider>
      );
    };

    // COMPONENT: BuddyDisplay
    const BuddyDisplay = ({
      buddyId,
      mood,
      message,
      isPlayingVideo,
      onVideoEnd,
      isPlayingSleepyVideo,
      onSleepyVideoEnd
    }) => {
      const buddy = buddies.find(b => b.id === buddyId);
      const videoRef = useRef(null);
      const sleepyVideoRef = useRef(null);
      const [sleepyVideoEnded, setSleepyVideoEnded] = useState(false);

      if (!buddy) return null;
      const asset = buddy.assets[mood] || buddy.assets.happy;
      const videoHappyAsset = buddy.assets.videoHappy;
      const videoSleepyAsset = buddy.assets.videoSleepy;

      // Auto-play happy video when isPlayingVideo becomes true
      useEffect(() => {
        if (isPlayingVideo && videoRef.current && videoHappyAsset) {
          videoRef.current.currentTime = 0;
          videoRef.current.play().catch(e => console.log('Video play error:', e));
        }
      }, [isPlayingVideo, videoHappyAsset]);

      // Auto-play sleepy video when isPlayingSleepyVideo becomes true
      useEffect(() => {
        if (isPlayingSleepyVideo && sleepyVideoRef.current && videoSleepyAsset) {
          setSleepyVideoEnded(false);
          sleepyVideoRef.current.currentTime = 0;
          sleepyVideoRef.current.play().catch(e => console.log('Sleepy video play error:', e));
        }
      }, [isPlayingSleepyVideo, videoSleepyAsset]);

      const handleVideoEnded = () => {
        if (onVideoEnd) onVideoEnd();
      };

      const handleSleepyVideoEnded = () => {
        setSleepyVideoEnded(true);
        // Video stays on last frame (no more action needed)
        if (onSleepyVideoEnd) onSleepyVideoEnd();
      };

      // Determine which layer to show
      const showHappyVideo = isPlayingVideo && videoHappyAsset;
      const showSleepyVideo = (isPlayingSleepyVideo || sleepyVideoEnded) && videoSleepyAsset && mood === 'sleepy';
      const showStaticImage = !showHappyVideo && !showSleepyVideo;

      return (
        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
          {message && (
            <div style={{
              background: 'white',
              padding: '1rem',
              borderRadius: '24px',
              borderBottomLeftRadius: '4px',
              boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
              marginBottom: '1rem',
              maxWidth: '200px',
              textAlign: 'center',
              animation: 'popIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28)',
              fontFamily: 'Fredoka, sans-serif',
              color: '#2D2D2D'
            }}>
              {message}
            </div>
          )}

          {/* Buddy image/video container - stacked in same position */}
          <div style={{ position: 'relative', width: '200px', height: '200px' }}>
            {/* Happy Video layer */}
            {videoHappyAsset && (
              <video
                ref={videoRef}
                src={videoHappyAsset}
                onEnded={handleVideoEnded}
                playsInline
                style={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  width: '200px',
                  height: '200px',
                  objectFit: 'contain',
                  opacity: showHappyVideo ? 1 : 0,
                  transition: 'opacity 0.3s ease',
                  pointerEvents: 'none'
                }}
              />
            )}

            {/* Sleepy Video layer */}
            {videoSleepyAsset && (
              <video
                ref={sleepyVideoRef}
                src={videoSleepyAsset}
                onEnded={handleSleepyVideoEnded}
                playsInline
                style={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  width: '200px',
                  height: '200px',
                  objectFit: 'contain',
                  opacity: showSleepyVideo ? 1 : 0,
                  transition: 'opacity 0.3s ease',
                  pointerEvents: 'none'
                }}
              />
            )}

            {/* Static image layer */}
            <img
              src={asset}
              alt={`${buddy.name} is ${mood}`}
              style={{
                position: 'absolute',
                top: 0,
                left: 0,
                width: '200px',
                height: '200px',
                objectFit: 'contain',
                opacity: showStaticImage ? 1 : 0,
                transition: 'opacity 0.3s ease'
              }}
            />
          </div>

          <style>{`
                      @keyframes popIn {
                          0% { transform: scale(0); opacity: 0; }
                          100% { transform: scale(1); opacity: 1; }
                      }
                  `}</style>
        </div>
      );
    };

    // COMPONENT: BuddySelector
    const BuddySelector = () => {
      const { setCurrentBuddyId, setView, goals } = useContext(AppContext);

      const handleSelect = (buddyId) => {
        setCurrentBuddyId(buddyId);
        if (goals.length === 0) {
          setView('settings');
        } else {
          setView('practice');
        }
      };

      return (
        <div className="buddy-selector-container" style={{ padding: '2rem', textAlign: 'center' }}>
          <h1 style={{ fontFamily: 'Fredoka, sans-serif', color: '#2D2D2D', marginBottom: '1rem' }}>
            Pick Your Piano Buddy!
          </h1>
          <p style={{ color: '#6B7280', marginBottom: '2rem' }}>
            Who will practice with you today?
          </p>

          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>
            {buddies.map(buddy => (
              <div
                key={buddy.id}
                onClick={() => handleSelect(buddy.id)}
                className="btn"
                style={{
                  background: buddy.color,
                  borderRadius: '24px',
                  padding: '1.5rem',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  boxShadow: '0 10px 15px rgba(0,0,0,0.1)'
                }}
              >
                <img
                  src={buddy.assets.happy}
                  alt={buddy.name}
                  style={{ width: '120px', height: '120px', objectFit: 'contain', marginBottom: '1rem', filter: 'drop-shadow(0 4px 6px rgba(0,0,0,0.1))' }}
                />
                <span style={{
                  fontFamily: 'Fredoka, sans-serif',
                  fontSize: '1.25rem',
                  color: 'white'
                }}>
                  {buddy.name}
                </span>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // COMPONENT: ParentSettings
    const ParentSettings = () => {
      const {
        goals,
        addGoal,
        removeGoal,
        inactivityThreshold,
        setInactivityThreshold,
        setView
      } = useContext(AppContext);

      const [tuneName, setTuneName] = useState('');
      const [counts, setCounts] = useState(5);

      const handleAdd = (e) => {
        e.preventDefault();
        if (tuneName.trim()) {
          addGoal(tuneName, counts);
          setTuneName('');
          setCounts(5);
        }
      };

      return (
        <div style={{ padding: '2rem', height: '100%', overflowY: 'auto' }}>
          <h1 style={{ fontFamily: 'Fredoka, sans-serif', marginBottom: '1.5rem' }}>Settings</h1>

          <section style={{ marginBottom: '2rem' }}>
            <h2 style={{ fontSize: '1.1rem', marginBottom: '1rem' }}>Daily Goals</h2>

            <form onSubmit={handleAdd} style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
              <input
                type="text"
                placeholder="Tune Name (e.g. Minuet)"
                value={tuneName}
                onChange={(e) => setTuneName(e.target.value)}
                style={{ flex: 1, padding: '0.75rem', borderRadius: '12px', border: '1px solid #E5E7EB', fontSize: '1rem' }}
              />
              <input
                type="number"
                min="1"
                max="50"
                value={counts}
                onChange={(e) => setCounts(e.target.value)}
                style={{ width: '80px', padding: '0.75rem', borderRadius: '12px', border: '1px solid #E5E7EB', fontSize: '1rem' }}
              />
              <button type="submit" className="btn" style={{ background: '#2D2D2D', color: 'white', padding: '0 1.5rem', borderRadius: '12px' }}>Add</button>
            </form>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
              {goals.map(goal => (
                <div key={goal.id} style={{
                  background: 'white',
                  padding: '1rem',
                  borderRadius: '12px',
                  border: '1px solid #E5E7EB',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center'
                }}>
                  <div>
                    <strong style={{ display: 'block' }}>{goal.tuneName}</strong>
                    <span style={{ color: '#6B7280' }}>{goal.targetCount} times</span>
                  </div>
                  <button onClick={() => removeGoal(goal.id)} style={{ background: 'none', border: 'none', color: '#EF4444', cursor: 'pointer', padding: '0.5rem' }}>Remove</button>
                </div>
              ))}
              {goals.length === 0 && <p style={{ color: '#9CA3AF', fontStyle: 'italic' }}>No goals added yet.</p>}
            </div>
          </section>

          <button
            className="btn"
            onClick={() => setView('practice')}
            disabled={goals.length === 0}
            style={{
              width: '100%',
              padding: '1rem',
              background: goals.length > 0 ? '#4BC2A5' : '#D1D5DB',
              color: 'white',
              fontSize: '1.2rem',
              borderRadius: '16px',
              marginTop: 'auto'
            }}
          >
            Start Practicing!
          </button>
        </div>
      );
    };

    // COMPONENT: PracticeView
    const PracticeView = () => {
      const {
        currentBuddyId,
        goals,
        incrementProgress,
        inactivityThreshold,
        setInactivityThreshold,
        setView,
        sessionActiveSeconds,
        setSessionActiveSeconds,
        hasStarted
      } = useContext(AppContext);

      // Mood & Audio State
      const [mood, setMood] = useState('happy');
      const [message, setMessage] = useState('');
      const lastPracticeRef = useRef(Date.now());
      const daydreamingStartRef = useRef(null); // Separate ref for daydreaming countdown
      const snoreAudioRef = useRef(null);
      const [isSnoozeMuted, setIsSnoozeMuted] = useState(false);
      const [isDaydreaming, setIsDaydreaming] = useState(false);
      const [isPlayingVideo, setIsPlayingVideo] = useState(false);
      const [isPlayingSleepyVideo, setIsPlayingSleepyVideo] = useState(false);
      const [hasPlayedSleepyVideo, setHasPlayedSleepyVideo] = useState(false);
      const [_, setTick] = useState(0);

      // Derived State
      const totalTarget = goals.reduce((acc, g) => acc + g.targetCount, 0);
      const totalCurrent = goals.reduce((acc, g) => acc + g.currentCount, 0);
      const overallProgress = totalTarget > 0 ? (totalCurrent / totalTarget) * 100 : 0;
      const isAllDone = goals.length > 0 && totalCurrent >= totalTarget;

      // Voice State
      const voiceRef = useRef(null);

      // Initialize Voice
      useEffect(() => {
        const setVoice = () => {
          const voices = window.speechSynthesis.getVoices();
          if (voices.length === 0) return;
          let candidate = null;

          // Logic for voice selection based on buddy
          // Sparkle and Splash should both be female-sounding (toddler style)
          const isFemale = currentBuddyId === 'melody' || currentBuddyId === 'sparkle' || currentBuddyId === 'splash';

          if (isFemale) {
            candidate = voices.find(v => v.name.includes('Google US English')) ||
              voices.find(v => v.name.includes('Samantha')) ||
              voices.find(v => v.name.includes('Female')) ||
              voices.find(v => v.lang === 'en-US');
          } else {
            candidate = voices.find(v => v.name.includes('Google UK English Male')) ||
              voices.find(v => v.name.includes('Daniel')) ||
              voices.find(v => v.name.includes('Male')) ||
              voices.find(v => v.lang === 'en-US');
          }
          voiceRef.current = candidate || voices[0];
        };
        setVoice();
        window.speechSynthesis.onvoiceschanged = setVoice;
        return () => { window.speechSynthesis.onvoiceschanged = null; }
      }, [currentBuddyId]);

      // TTS Helper
      const speak = (text, emotion, overrideEmotion = null) => {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel();

        if (snoreAudioRef.current) {
          snoreAudioRef.current.pause();
          snoreAudioRef.current.currentTime = 0;
        }

        const utterance = new SpeechSynthesisUtterance(text);
        if (voiceRef.current) utterance.voice = voiceRef.current;

        // Base Pitch Logic
        let basePitch = 1.0;
        let baseRate = 1.0;

        switch (currentBuddyId) {
          case 'melody': basePitch = 1.2; break;
          case 'rhythm': basePitch = 0.9; break;
          // Unicorn: Toddler, cute, naughty (Lowered pitch from 1.5 to 1.3 to avoid breaking)
          case 'sparkle': basePitch = 1.3; baseRate = 1.1; break;
          // Dolphin: Toddler girl, giggles, playful (High pitch, fast)
          case 'splash': basePitch = 1.4; baseRate = 1.2; break;
          default: basePitch = 1.0;
        }

        const targetEmotion = overrideEmotion || emotion;

        switch (targetEmotion) {
          case 'happy':
            utterance.pitch = basePitch + 0.1;
            utterance.rate = baseRate + 0.1;
            break;
          case 'anxious':
            utterance.pitch = basePitch + 0.05;
            utterance.rate = baseRate + 0.2;
            break;
          case 'sleepy':
            utterance.pitch = basePitch - 0.1;
            utterance.rate = baseRate * 0.8;
            utterance.volume = 0.6;
            break;
          default:
            utterance.pitch = basePitch;
            utterance.rate = baseRate;
        }
        window.speechSynthesis.speak(utterance);
      };

      // Snooze Logic (Real Sound)
      // Snooze Logic (Real Sound) - Only start AFTER video ends
      useEffect(() => {
        let snoozeInterval = null;

        // Condition: Mood is sleepy, video has finished, and not muted
        const readyToSnore = mood === 'sleepy' && !isAllDone && hasPlayedSleepyVideo;

        if (readyToSnore) {
          const playSnore = () => {
            if (isSnoozeMuted) return;
            if (snoreAudioRef.current) {
              snoreAudioRef.current.currentTime = 0;
              snoreAudioRef.current.play().catch(e => console.log('Audio play error:', e));
            }
          };

          if (!snoreAudioRef.current) {
            snoreAudioRef.current = new Audio('https://www.orangefreesounds.com/wp-content/uploads/2015/11/Cartoon-snoring.mp3');
            snoreAudioRef.current.volume = 0.4;
          }

          // Start loop
          snoozeInterval = setInterval(playSnore, 4000); // Loop every 4s
          playSnore(); // Immediate first snore
        } else {
          // Stop everything if mood changes or video is playing
          if (snoozeInterval) clearInterval(snoozeInterval);
          if (snoreAudioRef.current) {
            snoreAudioRef.current.pause();
            snoreAudioRef.current.currentTime = 0;
          }
          setIsSnoozeMuted(false);
        }
        return () => {
          if (snoozeInterval) clearInterval(snoozeInterval);
          if (snoreAudioRef.current) snoreAudioRef.current.pause();
        };
      }, [mood, isAllDone, isSnoozeMuted, hasPlayedSleepyVideo]);

      // Timer & State Transitions
      useEffect(() => {
        if (isAllDone) {
          setMood('happy');
          setIsDaydreaming(false);
          return;
        }

        const interval = setInterval(() => {
          // ACTIVE TIME LOGIC:
          // Count ONLY if: Started AND Not Sleepy AND Not Daydreaming
          if (hasStarted && mood !== 'sleepy' && !isDaydreaming) {
            setSessionActiveSeconds(prev => prev + 1);
          }

          // MOOD TRANSITION LOGIC:
          // ONLY trigger countdown if isDaydreaming is true
          if (isDaydreaming && daydreamingStartRef.current) {
            const elapsedMinutes = (Date.now() - daydreamingStartRef.current) / 60000;

            if (elapsedMinutes >= inactivityThreshold) {
              if (mood !== 'sleepy') {
                const transitionPhrase = "I am feeling sleepy now...";
                setMessage(transitionPhrase);
                speak(transitionPhrase, 'sleepy', 'happy');
                setMood('sleepy');
                // Trigger sleepy video
                setIsPlayingSleepyVideo(true);
                setHasPlayedSleepyVideo(false);
              }
            } else if (elapsedMinutes >= inactivityThreshold / 2) {
              if (mood !== 'anxious') {
                setMood('anxious');
                const anxiousQuote = quotes.anxious[Math.floor(Math.random() * quotes.anxious.length)];
                setMessage(anxiousQuote);
                speak(anxiousQuote, 'anxious');
              }
            }
          } else if (!isDaydreaming) {
            // If NOT Daydreaming, Buddy is ALWAYS Happy
            if (mood !== 'happy') setMood('happy');
          }
        }, 1000);
        return () => clearInterval(interval);
      }, [inactivityThreshold, mood, isAllDone, hasStarted, isDaydreaming]);

      useEffect(() => {
        if (isAllDone) {
          const count = 200;
          const defaults = { origin: { y: 0.7 } };
          window.confetti && window.confetti({ ...defaults, particleCount: count, spread: 70, startVelocity: 40 });
          setMessage("ALL GOALS FINISHED! YAY!");
          speak("Amazing! You finished everything! You are a super star!", 'happy');
        }
      }, [isAllDone]);

      const handleProgress = (goalId) => {
        lastPracticeRef.current = Date.now();
        setMood('happy');
        setIsDaydreaming(false); // Resume active practice
        incrementProgress(goalId);

        let quoteToSpeak;
        if (mood === 'sleepy') {
          quoteToSpeak = "I'm awake! Let's play!";
        } else {
          quoteToSpeak = quotes.happy[Math.floor(Math.random() * quotes.happy.length)];
        }
        setMessage(quoteToSpeak);

        // Speak first, then play video with sound when speech ends
        speakThenVideo(quoteToSpeak);
      };

      // Speak, then trigger video when speech ends
      const speakThenVideo = (text) => {
        if (!window.speechSynthesis) {
          setIsPlayingVideo(true); // Fallback: just play video
          return;
        }
        window.speechSynthesis.cancel();

        if (snoreAudioRef.current) {
          snoreAudioRef.current.pause();
          snoreAudioRef.current.currentTime = 0;
        }

        const utterance = new SpeechSynthesisUtterance(text);
        if (voiceRef.current) utterance.voice = voiceRef.current;

        // Get base pitch/rate for buddy
        let basePitch = 1.0, baseRate = 1.0;
        switch (currentBuddyId) {
          case 'melody': basePitch = 1.2; break;
          case 'rhythm': basePitch = 0.9; break;
          case 'sparkle': basePitch = 1.3; baseRate = 1.1; break;
          case 'splash': basePitch = 1.4; baseRate = 1.2; break;
        }
        utterance.pitch = basePitch + 0.1;
        utterance.rate = baseRate + 0.1;

        // When speech ends, trigger video
        utterance.onend = () => {
          setIsPlayingVideo(true);
        };

        window.speechSynthesis.speak(utterance);
      };

      const handleVideoEnd = () => {
        setIsPlayingVideo(false);
      };

      const handleSleepyVideoEnd = () => {
        setHasPlayedSleepyVideo(true);
      };

      const handleImPlaying = (e) => {
        e.stopPropagation();
        setIsSnoozeMuted(true);
      };

      const handleResumeSleep = (e) => {
        e.stopPropagation();
        setIsSnoozeMuted(false);
      };

      const formatTime = (totalSeconds) => {
        const m = Math.floor(totalSeconds / 60);
        const s = totalSeconds % 60;
        return `${m}m ${s} s`;
      };

      return (
        <div
          style={{
            padding: '2rem',
            height: '100%',
            display: 'flex',
            flexDirection: 'column',
            background: mood === 'sleepy' && !isAllDone ? '#F3F4F6' : 'white',
            transition: 'background 1s ease',
            overflowY: 'auto',
            overflowX: 'hidden',
            WebkitOverflowScrolling: 'touch'
          }}
        >
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
            <button onClick={(e) => { e.stopPropagation(); setView('settings'); }} style={{ background: 'none', border: 'none', color: '#9CA3AF', cursor: 'pointer' }}>⚙️ Settings</button>
            <div style={{ fontFamily: 'Fredoka, sans-serif', color: '#4BC2A5' }}>
              {isAllDone ? `Total Time: ${formatTime(sessionActiveSeconds)} ` : `${Math.round(overallProgress)}% Done Today`}
            </div>
          </div>

          <div style={{ display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', padding: '0.5rem 0' }}>
            <div style={{
              animation: isAllDone ? 'bounce 1s infinite' : 'none',
              transformOrigin: 'bottom'
            }}>
              <BuddyDisplay
                buddyId={currentBuddyId}
                mood={mood}
                message={message}
                isPlayingVideo={isPlayingVideo}
                onVideoEnd={handleVideoEnd}
                isPlayingSleepyVideo={isPlayingSleepyVideo}
                onSleepyVideoEnd={handleSleepyVideoEnd}
              />
            </div>

            {mood === 'sleepy' && !isAllDone && (
              <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.5rem' }}>
                <button
                  onClick={handleImPlaying}
                  className="btn"
                  style={{
                    background: '#FF8F5E',
                    color: 'white',
                    padding: '0.5rem 1rem',
                    borderRadius: '20px',
                    fontSize: '0.9rem',
                    opacity: isSnoozeMuted ? 0.5 : 1,
                    cursor: isSnoozeMuted ? 'default' : 'pointer'
                  }}
                  disabled={isSnoozeMuted}
                >
                  {isSnoozeMuted ? "Shhh... (Muted)" : "I'm Playing! (Shhh!)"}
                </button>

                {isSnoozeMuted && (
                  <button
                    onClick={handleResumeSleep}
                    className="btn"
                    style={{
                      background: '#4BC2A5',
                      color: 'white',
                      padding: '0.5rem 1rem',
                      borderRadius: '20px',
                      fontSize: '0.9rem',
                      cursor: 'pointer'
                    }}
                  >
                    Go back to sleep
                  </button>
                )}
              </div>
            )}

            <style>{`
    @keyframes bounce {
      0 %, 100 % { transform: translateY(0); }
      50 % { transform: translateY(-20px); }
    }
    `}</style>
          </div>

          <div style={{ marginTop: 'auto', display: 'flex', flexDirection: 'column', gap: '1rem' }}>
            {goals.map(goal => {
              const isDone = goal.currentCount >= goal.targetCount;
              const progress = Math.min((goal.currentCount / goal.targetCount) * 100, 100);
              return (
                <div key={goal.id} style={{ background: '#F9FAFB', borderRadius: '16px', padding: '1rem', border: isDone ? '2px solid #4BC2A5' : '1px solid #E5E7EB' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                    <span style={{ fontWeight: '600' }}>{goal.tuneName}</span>
                    <span style={{ color: '#6B7280' }}>{goal.currentCount} / {goal.targetCount}</span>
                  </div>
                  <div style={{ height: '8px', background: '#E5E7EB', borderRadius: '4px', marginBottom: '1rem', overflow: 'hidden' }}>
                    <div style={{ width: `${progress}%`, height: '100%', background: isDone ? '#4BC2A5' : '#FF8F5E', transition: 'width 0.5s ease' }}></div>
                  </div>
                  <button
                    onClick={(e) => { e.stopPropagation(); if (!isDone) handleProgress(goal.id); }}
                    className="btn"
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      background: isDone ? '#10B981' : '#2D2D2D',
                      color: 'white',
                      borderRadius: '12px',
                      cursor: isDone ? 'default' : 'pointer',
                      opacity: isDone ? 0.8 : 1
                    }}
                  >
                    {isDone ? 'Goal Complete! ★' : 'Finished One Time!'}
                  </button>
                </div>
              );
            })}
          </div>

          {/* Daydreaming Controls - Hidden at bottom */}
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '0.5rem',
            marginTop: '2rem',
            paddingTop: '1rem',
            borderTop: '1px solid #E5E7EB',
            opacity: 0.6
          }}>
            <button
              onClick={(e) => {
                e.stopPropagation();
                setIsDaydreaming(true);
                daydreamingStartRef.current = Date.now();
              }}
              style={{
                padding: '0.4rem 0.8rem',
                background: isDaydreaming ? '#9CA3AF' : '#E5E7EB',
                color: isDaydreaming ? 'white' : '#6B7280',
                border: 'none',
                borderRadius: '16px',
                cursor: isDaydreaming ? 'default' : 'pointer',
                fontSize: '0.8rem'
              }}
            >
              {isDaydreaming ? "Daydreaming..." : "Daydreaming Now"}
            </button>
            <select
              value={inactivityThreshold}
              onChange={(e) => {
                e.stopPropagation();
                setInactivityThreshold(Number(e.target.value));
              }}
              onClick={(e) => e.stopPropagation()}
              style={{
                padding: '0.4rem',
                borderRadius: '8px',
                border: '1px solid #E5E7EB',
                fontSize: '0.8rem',
                color: '#6B7280',
                cursor: 'pointer'
              }}
            >
              <option value={0.5}>30s</option>
              <option value={1}>1m</option>
              <option value={2}>2m</option>
              <option value={3}>3m</option>
              <option value={5}>5m</option>
              <option value={8}>8m</option>
            </select>
          </div>
        </div>
      );
    };

    // MAIN: App
    const App = () => {
      const { view } = useContext(AppContext);
      const renderView = () => {
        switch (view) {
          case 'onboarding': return <BuddySelector />;
          case 'settings': return <ParentSettings />;
          case 'practice': return <PracticeView />;
          default: return <BuddySelector />;
        }
      };
      return <div style={{ height: '100%', width: '100%' }}>{renderView()}</div>;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AppProvider><App /></AppProvider>);
  </script>
</body>

</html>